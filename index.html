<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Redirigiendo al generador de fotomosaicosâ€¦</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{font-family:system-ui,sans-serif;color-scheme:light dark}
    body{margin:0;display:grid;place-items:center;min-height:100vh;background:#0d1117;color:#c9d1d9}
    #msg{max-width:26rem;text-align:center;font-size:1rem;line-height:1.4}
  </style>
</head>
<body>
  <p id="msg">Comprobando servidorâ€¦</p>

  <script>
    const WORKER_URL = "https://fotomosaico.acqacq2000.workers.dev";
    const POD_ID     = "ao66w2zl6kzlss";
    const POD_URL    = `https://${POD_ID}-5000.proxy.runpod.net/`;

    const msg = document.getElementById("msg");

    async function api(path = "", opts = {}) {
      const r = await fetch(`${WORKER_URL}${path}`, opts);
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    }

    async function getStatus() {
      const data = await api("");
      return (data.status || data.desiredStatus || "UNKNOWN").toUpperCase();
    }

    async function waitUntilHttpOk(url, maxTries = 180) { // 180 Ã— 2 s = 6 min
      const sleep = ms => new Promise(r => setTimeout(r, ms));
      for (let i = 0; i < maxTries; i++) {
        try {
          const r = await fetch(url, { method: "GET", mode: "no-cors" });
          if (r.ok || r.type === "opaque") return true;
        } catch {}
        await sleep(2000);
      }
      return false;
    }

    async function main() {
      try {
        msg.textContent = "Comprobando estado del servidorâ€¦";
        let st = await getStatus();
        if (st !== "RUNNING") {
          msg.textContent = "Encendiendo el servidor, espera por favorâ€¦";
          await api("/start", { method: "POST" });
          for (let i = 0; i < 40 && st !== "RUNNING"; i++) {
            await new Promise(r => setTimeout(r, 5000));
            st = await getStatus();
          }
        }

        msg.textContent = "Servidor encendido. Preparando la aplicaciÃ³nâ€¦";
        const ok = await waitUntilHttpOk(POD_URL);
        if (ok) {
          msg.textContent = "Redirigiendo al generador de fotomosaicosâ€¦";
          await new Promise(r => setTimeout(r, 1000));
          window.location.href = POD_URL;
        } else {
          msg.textContent = "ðŸ›‘ No se pudo acceder a la aplicaciÃ³n. Intenta de nuevo mÃ¡s tarde.";
        }
      } catch (e) {
        msg.textContent = `Error: ${e.message}`;
      }
    }

    main();
  </script>
</body>
</html>
