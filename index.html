<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Generador de fotomosaicos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{font-family:system-ui,sans-serif;color-scheme:light dark}
    html,body{margin:0;height:100%}
    #overlay{position:fixed;inset:0;display:grid;place-items:center;background:#0d1117;color:#c9d1d9;z-index:10}
    #frame{border:none;width:100%;height:100%;display:none}
  </style>
</head>
<body>
  <div id="overlay">Preparando el generador de fotomosaicosâ€¦</div>
  <iframe id="frame" sandbox="allow-scripts allow-same-origin allow-downloads"></iframe>

  <script>
    const WORKER_URL = "https://fotomosaico.acqacq2000.workers.dev";
    const POD_ID     = "ao66w2zl6kzlss";
    const POD_URL    = `https://${POD_ID}-5000.proxy.runpod.net/`;

    const overlay = document.getElementById("overlay");
    const frame   = document.getElementById("frame");
    let podRunning=false;

    const sleep = ms=>new Promise(r=>setTimeout(r,ms));
    const api   =(p="",o={})=>fetch(`${WORKER_URL}${p}`,o).then(r=>r.ok?r.json():Promise.reject(r));
    const getSt =()=>api("").then(d=>(d.status||d.desiredStatus||"UNKNOWN").toUpperCase());

    async function waitHttpOk(url,max=180){
      for(let i=0;i<max;i++){
        try{const r=await fetch(url,{method:"GET",mode:"no-cors"});if(r.ok||r.type==="opaque")return true;}catch{}
        await sleep(2000);
      }
      return false;
    }

    async function startFlow(){
      overlay.textContent="Comprobando servidorâ€¦";
      let st=await getSt();
      if(st!=="RUNNING"){
        overlay.textContent="Encendiendo servidorâ€¦";
        await api("/start",{method:"POST"});
        for(let i=0;i<40&&st!=="RUNNING";i++){
          await sleep(5000); st=await getSt();
        }
      }
      overlay.textContent="Cargando aplicaciÃ³nâ€¦";
      if(await waitHttpOk(POD_URL)){
        podRunning=true;
        frame.src=POD_URL;
        frame.style.display="block";
        overlay.style.display="none";
      }else{
        overlay.textContent="ðŸ›‘ No respondiÃ³ a tiempo, intÃ©ntalo mÃ¡s tarde.";
      }
    }

    window.addEventListener("beforeunload",()=>{
      if(podRunning) navigator.sendBeacon && navigator.sendBeacon(`${WORKER_URL}/stop`);
    });

    startFlow();
  </script>
</body>
</html>
