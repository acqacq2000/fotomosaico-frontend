<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Fotomosaico · Control de Pod</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      :root { font-family: system-ui, sans-serif; color-scheme: light dark; }
      body  { margin:0; display:grid; min-height:100vh; grid-template-rows:auto 1fr; background:#0d1117; color:#c9d1d9; }
      header{ padding:1rem 1.5rem; background:#161b22; }
      h1    { margin:0; font-size:1rem; letter-spacing:.05em; }
      main  { padding:1rem; display:flex; flex-direction:column; gap:1rem; }
      button{ padding:.75rem 1.5rem; border:0; border-radius:.5rem; font-size:1rem; cursor:pointer; transition:opacity .2s; }
      #startBtn{ background:#238636; color:#fff; }
      #stopBtn { background:#da3633; color:#fff; }
      button[disabled]{ opacity:.6; cursor:default; }
      iframe{ flex:1 1 auto; border:none; border-radius:.75rem; width:100%; min-height:70vh; display:none; }
    </style>
  </head>
  <body>
    <header><h1>Control del servidor Fotomosaico</h1></header>
    <main>
      <p id="status">Comprobando estado…</p>
      <button id="startBtn" style="display:none;">Encender y mostrar aplicación</button>
      <button id="stopBtn"  style="display:none;">Apagar servidor</button>
      <iframe id="appFrame"></iframe>
    </main>

    <script>
      // 👉 Sustituye por tus valores
      const POD_ID  = "x5y93442z3jok6";
      const API_KEY = "rpa_Y4JHF9VLDXJIJV0YVTSOGTJ5ETANHG7EMCTQU14B1peidw";
      const POD_URL = `https://${POD_ID}.runpod.run`;

      const BASE    = `https://rest.runpod.io/v1/pods/${POD_ID}`;
      const statusEl = document.getElementById('status');
      const startBtn = document.getElementById('startBtn');
      const stopBtn  = document.getElementById('stopBtn');
      const frame    = document.getElementById('appFrame');
      let podRunning = false;

      async function getStatus(){
        const res = await fetch(BASE,{headers:{Authorization:`Bearer ${API_KEY}`}});
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        return (data.status||data.desiredStatus||'UNKNOWN').toUpperCase();
      }

      async function startPod(){
        startBtn.disabled=true;
        statusEl.textContent='Arrancando…';
        await fetch(`${BASE}/start`,{method:'POST',headers:{Authorization:`Bearer ${API_KEY}`}});
        pollUntil('RUNNING');
      }

      async function stopPod(){
        if(!podRunning) return;
        stopBtn.disabled=true;
        statusEl.textContent='Apagando…';
        await fetch(`${BASE}/stop`,{method:'POST',headers:{Authorization:`Bearer ${API_KEY}`}});
        pollUntil('STOPPED');
      }

      // llamada síncrona en cierre de pestaña
      async function stopPodSync(){
        if(!podRunning) return;
        try{
          const headers={"Authorization":`Bearer ${API_KEY}`};
          if(navigator.sendBeacon){
            const blob=new Blob([],{type:'application/json'});
            navigator.sendBeacon(`${BASE}/stop`,blob, {headers});
          }else{
            fetch(`${BASE}/stop`,{method:'POST',headers,keepalive:true});
          }
        }catch(e){}
      }

      async function pollUntil(target){
        const delay=ms=>new Promise(r=>setTimeout(r,ms));
        for(let i=0;i<120;i++){
          try{
            const st=await getStatus();
            if(st===target){
              if(target==='RUNNING') readyState();
              else stoppedState();
              return;
            }
            statusEl.textContent=`${st.toLowerCase()}…`;
          }catch(e){ statusEl.textContent=e.message; }
          await delay(5000);
        }
        statusEl.textContent='⛔️ Tiempo agotado';
        startBtn.disabled=stopBtn.disabled=false;
      }

      function readyState(){
        podRunning=true;
        statusEl.textContent='Servidor en marcha ✅';
        frame.src=POD_URL;
        frame.style.display='block';
        stopBtn.style.display='inline-block';
        startBtn.style.display='none';
      }
      function stoppedState(){
        podRunning=false;
        statusEl.textContent='Servidor apagado 💤';
        frame.style.display='none';
        startBtn.style.display='inline-block';
        startBtn.disabled=false;
        stopBtn.style.display='none';
      }

      async function init(){
        try{
          const st=await getStatus();
          (st==='RUNNING')? readyState(): stoppedState();
        }catch(e){ statusEl.textContent=e.message; }
      }

      // Eventos
      startBtn.addEventListener('click',startPod);
      stopBtn.addEventListener('click',stopPod);
      window.addEventListener('beforeunload',stopPodSync);

      init();
    </script>
  </body>
</html>
